# Cloudflare Workers + Hono ãƒ¯ãƒ¼ã‚¯ã‚·ãƒ§ãƒƒãƒ—

è³‡æ–™ã¯ã“ã¡ã‚‰ => workshops.yusuke.run

`#serverlessdays`

- Yusuke Wada
- 2023-09-24 ServerlessDays Tokyo 2023
- [workshops.yusuke.run](https://workshops.yusuke.run/)

# ã‚¢ã‚¸ã‚§ãƒ³ãƒ€

1. ãƒ¯ãƒ¼ã‚¯ã‚·ãƒ§ãƒƒãƒ—ã«ã¤ã„ã¦
2. Workers ã‚¤ãƒ³ãƒˆãƒ­ãƒ€ã‚¯ã‚·ãƒ§ãƒ³
3. Hono ã‚¤ãƒ³ãƒˆãƒ­ãƒ€ã‚¯ã‚·ãƒ§ãƒ³
4. åŸºæœ¬ç·¨
5. ãƒ—ãƒ­ã‚­ã‚·ç·¨
6. Web APIç·¨
7. ãƒ•ãƒ«ã‚¹ã‚¿ãƒƒã‚¯ç·¨
8. AIç·¨
9. Honoã‚’ã‚ˆã‚Šæ·±ãçŸ¥ã‚‹
10. ãã®ä»–

# 1. ãƒ¯ãƒ¼ã‚¯ã‚·ãƒ§ãƒƒãƒ—ã«ã¤ã„ã¦

## 1.1 å¯¾è±¡

### å¯¾è±¡è€…

- Cloudflareã§ã®ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ä½œæˆã«èˆˆå‘³ã®ã‚ã‚‹æ–¹
- Honoã‚’ä½¿ã£ã¦ã¿ãŸã„æ–¹
- ãƒ•ãƒ­ãƒ³ãƒˆã€ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰å•ã„ã¾ã›ã‚“

### å‰ææ¡ä»¶

- WranglerãŒå‹•ãç’°å¢ƒã‚’ã¤ãã£ã¦ãŠã
- `npx wrangler` ãŒå‹•ã
- JavaScriptã«å¯¾ã™ã‚‹çŸ¥è­˜ãŒã‚ã‚‹ã¨ã‚ˆã„

## 1.2 è‡ªå·±ç´¹ä»‹

### è‡ªå·±ç´¹ä»‹

- å’Œç”°è£•ä»‹
- 2023å¹´4æœˆã€œ Developer Advocate @Cloudflare
- ãƒœã‚±ã¦ co-founder
- Creator of Hono
- <https://x.com/yusukebe>
- <https://github.com/yusukebe>

### Developer Relations ãƒãƒ¼ãƒ 

- Emerging Technologies & Incubation æ‰€å±
- Manager, Developer Advocate x 3, Community Manager x 2
- NY, Austin, Amsterdam, Lisbon, SF, Tokyo

### æ™‚å·®ã™ã”ã„

![SS](https://ss.yusukebe.com/9ed6a6aa390ff6dd31da5bec7a3e44f5160a5d24abdac2d91171906ad0c4fc21_800x425.png)

### ã‚„ã£ã¦ã‚‹ã“ã¨

- Honoã®é–‹ç™º
- ãƒãƒ¥ãƒ¼ãƒˆãƒªã‚¢ãƒ«ã®ä½œæˆ
- ã‚¤ãƒ™ãƒ³ãƒˆç™»å£‡
- ã‚¤ãƒ™ãƒ³ãƒˆé–‹å‚¬
- ãƒ¯ãƒ¼ã‚¯ã‚·ãƒ§ãƒƒãƒ—è¬›å¸«
- é ‘å¼µã£ã¦ã„ã¾ã™

# 2. Workers ã‚¤ãƒ³ãƒˆãƒ­ãƒ€ã‚¯ã‚·ãƒ§ãƒ³

## 2.1 Cloudflare Workers/Pagesã«ã¤ã„ã¦

- Cloudflareã®ã‚¨ãƒƒã‚¸ã§å®Ÿè¡Œã•ã‚Œã‚‹ã‚µãƒ¼ãƒãƒ¼ãƒ¬ã‚¹ç’°å¢ƒ

### Cloudflare Workers

> Build serverless applications and deploy instantly across the globe for exceptional performance, reliability, and scale.
>
> ã‚µãƒ¼ãƒãƒ¼ãƒ¬ã‚¹ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’æ§‹ç¯‰ã—ã€å“è¶Šã—ãŸãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã€ä¿¡é ¼æ€§ã€ã‚¹ã‚±ãƒ¼ãƒ«ã®ãŸã‚ã«ä¸–ç•Œä¸­ã«å³åº§ã«ãƒ‡ãƒ—ãƒ­ã‚¤ã—ã¾ã™ã€‚
>
> https://developers.cloudflare.com/workers/

### Cloudflare Pages

> Deploy dynamic front-end applications in record time.
>
> å‹•çš„ãªãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ãƒ»ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’è¨˜éŒ²çš„ãªé€Ÿã•ã§å±•é–‹ã€‚
>
> https://developers.cloudflare.com/pages/


## 2.2 Cloudflare Workers

- è¨­å®šã€ãƒ¡ãƒ³ãƒ†å¿…è¦ãªã—ã®ã‚µãƒ¼ãƒãƒ¼ãƒ¬ã‚¹ç’°å¢ƒã‚’æä¾›
- Cloudflareã®ã‚¨ãƒƒã‚¸ã«å³åº§ã«ãƒ‡ãƒ—ãƒ­ã‚¤ã•ã‚Œã‚‹
- ãƒ•ãƒªãƒ¼ãƒ—ãƒ©ãƒ³ã§ã ã„ã¶éŠã¹ã‚‹
- [Workers Playground](https://workers.cloudflare.com/playground)

### Cloudflare Workersã®æ€æƒ³

![SS](https://ss.yusukebe.com/4ad5531eece2c6dd3d39c00c79a70cc2a213809ace6144b16efba0d03e30b2e0_800x303.png)

- [Cloudflare Workersã®ã”ç´¹ä»‹ï¼šã‚¨ãƒƒã‚¸ã§JavaScript Service Workersã‚’å®Ÿè¡Œã™ã‚‹](https://blog.cloudflare.com/ja-jp/introducing-cloudflare-workers-ja-jp/)
- 2017å¹´9æœˆã®è¨˜äº‹
- Cloudflareã®ã‚¨ãƒƒã‚¸ã‚’ãƒ—ãƒ­ã‚°ãƒ©ãƒ å¯èƒ½ã«ã™ã‚‹
- æ¤œè¨ã—ãŸçµæœJavaScriptã«è¡Œãç€ã
- V8ã‚’æ¡ç”¨ã€è¤‡æ•°ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’å®‰å…¨ã«å®Ÿè¡Œ
- Service Worker APIã‚’æ¡ç”¨ã€ãƒ–ãƒ©ã‚¦ã‚¶ç”¨ã ãŒå®Ÿã¯ã‚¨ãƒƒã‚¸ã«ã‚‚é©ã—ã¦ã„ã‚‹
- Web APIã¨ã—ã¦è³¢ãè¨­è¨ˆã•ã‚Œã¦ã„ã‚‹

### Wrangler

- Workersã®ãŸã‚ã®CLI
- Workersãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®ä½œæˆã€ãƒ†ã‚¹ãƒˆã€ãƒ‡ãƒ—ãƒ­ã‚¤
- Pagesã§ã‚‚ä½¿ç”¨
- Bindingsã®ç®¡ç†ã‚„`tail`ãªã©ã‚‚

![SS](https://ss.yusukebe.com/0da11c72988072caed24086d59f5b21535a3bfa3a3d587079ac41f690ca91385_800x486.png)

## 2.3 Bindings

Cloudflareã®ãƒªã‚½ãƒ¼ã‚¹ã¨Workersã‚’çµã¶

- KV
- Durable Objects
- R2
- D1
- Service Bindings
- Queue
- Email
- Constellation
- ãªã©

### KV

- ç´ æœ´ãªAPIã‚’å‚™ãˆãŸKey-Value store
- ã‚¢ã‚¯ã‚»ã‚¹ã•ã‚ŒãŸã‚‰ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã•ã‚Œã‚‹
- ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã•ã‚Œã‚‹ã¨é™çš„ãƒ•ã‚¡ã‚¤ãƒ«ã®ã‚ˆã†ã«é€Ÿã„
- Workers sites (éæ¨å¥¨) ã‚‚KVã§ã§ãã¦ã‚‹
- æ›¸ãè¾¼ã¿å¾Œã®åæ˜ ã«60ç§’ã‹ã‹ã‚‹ã“ã¨ã‚‚ã‚ã‚‹
- [How KV works](https://developers.cloudflare.com/workers/learning/how-kv-works/)

### Durable Objects

- åŒæ™‚ã«æ›¸ãè¾¼ã¿ã€ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³
- å¼·æ•´åˆæ€§
- ãƒãƒ£ãƒƒãƒˆãªã©ã€ãƒªã‚¢ãƒ«ã‚¢ã‚¤ãƒ ã€å‹•çš„ã‚³ãƒ³ãƒ†ãƒ³ãƒ„
- D1ã‚„R2ã¯ã“ã®ä¸Šã«æ§‹ç¯‰ã•ã‚Œã¦ã„ã‚‹
- KVã¯é™çš„ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚„è¨­å®šã€DOã¯å‹•çš„ãªçŠ¶æ…‹ç®¡ç†
- [Cloudflare Durable Objects](https://developers.cloudflare.com/durable-objects/)

### R2

- ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‚µãƒ¼ãƒ“ã‚¹
- ãƒ‡ãƒ¼ã‚¿ã‚¨ã‚°ãƒ¬ã‚¹ãŒç„¡æ–™
- AWS S3ã®APIã¨äº’æ›æ€§ãŒã‚ã‚‹
- ãƒ•ãƒ­ãƒ³ãƒˆã«Workersã‚’ç½®ãã“ã¨ãŒã§ãã‚‹
- [Cloudflare R2](https://developers.cloudflare.com/r2/)

### D1

- Workersã€Pagesã‹ã‚‰åˆ©ç”¨å¯èƒ½ãªSQLãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹
- ã‚ªãƒ¼ãƒ—ãƒ³ã‚¢ãƒ«ãƒ•ã‚¡
- SQLiteãŒDOã§å‹•ã„ã¦ã„ã‚‹
- [Cloudflare D1](https://developers.cloudflare.com/d1/)

### Service Bindings

- Workersé–“ã®é€šä¿¡å‡¦ç†ã‚’å¯èƒ½ã«ã™ã‚‹
- Publicãªã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒƒãƒˆã‚’çµŒç”±ã—ãªã„
- Workersã§ãƒã‚¤ã‚¯ãƒ­ã‚µãƒ¼ãƒ“ã‚¹ã‚’ä½œã‚‹
- [Service bindings](https://developers.cloudflare.com/workers/configuration/bindings/about-service-bindings/)

### Queue

- ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®é€å—ä¿¡ãŒå¯èƒ½
- ã‚ªãƒ¼ãƒ—ãƒ³ãƒ™ãƒ¼ã‚¿
- `queue`ã§å—ã‘å–ã‚Š
- [Cloudflare Queues](https://developers.cloudflare.com/queues/)

### Email

- è‡ªãƒ‰ãƒ¡ã‚¤ãƒ³ã®ã‚«ã‚¹ã‚¿ãƒ ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’ä½¿ç”¨
- å—ä¿¡ã—ãŸãƒ¡ãƒ¼ãƒ«ã‚’å—ä¿¡ãƒœãƒƒã‚¯ã‚¹ã¸ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°
- `email`ã§å—ã‘å–ã‚Š
- [Cloudflare Email Routing](https://developers.cloudflare.com/email-routing/)

### Constellation

- ãƒ™ãƒ¼ã‚¿
- Workersã§æ©Ÿæ¢°å­¦ç¿’ãƒ¢ãƒ‡ãƒ«ã‚’å‹•ã‹ã™
- äºˆã‚å­¦ç¿’æ¸ˆã¿ã®ãƒ‡ãƒ¼ã‚¿ã‚’ä½¿ç”¨
- [Constellation](https://developers.cloudflare.com/constellation/)

## 2.4 Cloudflare Pages

- ãƒ•ãƒ«ã‚¹ã‚¿ãƒƒã‚¯ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ç”¨
- å„ç¨®ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ãŒå‹•ã
- Functionsã§WorkersãŒå‹•ã
- [Cloudflare Pages](https://developers.cloudflare.com/pages/)

## 2.5 Workersã‚’çŸ¥ã‚‹ãŸã‚ã«

### ãƒªã‚½ãƒ¼ã‚¹

- [å…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ](https://developers.cloudflare.com/workers/)
- [ãƒ–ãƒ­ã‚°](https://blog.cloudflare.com/)
- [ãƒãƒ¥ãƒ¼ãƒˆãƒªã‚¢ãƒ«](https://developers.cloudflare.com/workers/tutorials/)
- [Discord](https://discord.gg/cloudflaredev)
- ã‚µãƒ¼ãƒ‰ãƒ‘ãƒ¼ãƒ†ã‚£ã®è¨˜äº‹
- ã‚¤ãƒ™ãƒ³ãƒˆ
  - [Cloudflare Workers Tech Talks #1](https://blog.yusu.ke/workers-tech-talks-1/)
  - [Cloudflare Meet-up - connpass](https://cfm-cts.connpass.com/)

## 2.6 ãã®ä»–ã®ã‚¨ãƒƒã‚¸ã§å®Ÿè¡Œã•ã‚Œã‚‹ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ 

- Fastly Compute@Edge
- AWS CloudFront Functions
- AWS Lambda@Edge
- Deno Deploy
- Vercel Edge Functions
- Netlify Functions
- Lagon
- ãã®ä»–

# 3. Hono ã‚¤ãƒ³ãƒˆãƒ­ãƒ€ã‚¯ã‚·ãƒ§ãƒ³

## 3.1 Honoã¨ã¯ï¼Ÿ

å‰¯é¡Œ

> Ultrafast framework for the Edges

ã‚‚ã—ãã¯

> The Web Framework built on Web Standards
>
> Lightweight, Ultrafast, Web Standards

> è»½é‡ã§ã€é€Ÿãã¦ã€Webæ¨™æº–ã‚’ä½¿ã£ã¦ã„ã‚‹

## 3.2 ãƒ¦ãƒ¼ã‚¹ã‚±ãƒ¼ã‚¹

- Web APIã®ä½œæˆ
- ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã‚µãƒ¼ãƒãƒ¼ã®ãƒ—ãƒ­ã‚­ã‚·
- CDNã®ãƒ•ãƒ­ãƒ³ãƒˆ
- ã‚¨ãƒƒã‚¸ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³
- ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã®ãƒ™ãƒ¼ã‚¹ã‚µãƒ¼ãƒãƒ¼
- ãƒ•ãƒ«ã‚¹ã‚¿ãƒƒã‚¯ã‚¢ãƒ—ãƒª

## 3.3 ã©ã“ã§ä½¿ã‚ã‚Œã¦ã„ã‚‹ã‹ï¼Ÿ

ä¸»ã«4ã¤ã®ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ 

- Cloudflare Workers
- Fastly Compute@Edge
- Deno
- Bun

### Cloudflare Workers

- [cdnjs API Server](https://cdnjs.com/api)
- [Drivly](https://driv.ly/)
- [repeat.dev](https://repeat.dev/)
- [drizzle-orm - Examples](https://github.com/drizzle-team/drizzle-orm)
- Cloudflare å…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã€ãƒãƒ¥ãƒ¼ãƒˆãƒªã‚¢ãƒ«
  - [Cloudflare D1ã§é™çš„ã‚µã‚¤ãƒˆã‚’å‹•çš„ã‚µã‚¤ãƒˆã«](https://blog.cloudflare.com/ja-jp/making-static-sites-dynamic-with-cloudflare-d1-ja-jp/)
  - [Query D1 from Hono Â· Cloudflare D1 docs](https://developers.cloudflare.com/d1/examples/d1-and-hono/)
  - [Build a Comments API Â· Cloudflare D1 docs](https://developers.cloudflare.com/d1/tutorials/build-a-comments-api/)
- Cloudflare Workers SDK
  - [workers-sdk/packages/playground-preview-worker](https://github.com/cloudflare/workers-sdk/tree/main/packages/playground-preview-worker)
  - [workers-sdk/packages/turbo-r2-archive](https://github.com/cloudflare/workers-sdk/tree/main/packages/turbo-r2-archive)
- Cloudflareç¤¾å†…

### Fastly Compute@Edge

- [Polyfill.io](https://www.polyfill.io/v3/)

### Deno

- Denoæœ¬ä½“
- [Deno Docs](https://docs.deno.com/runtime/manual)
- [Deno Benchmarks](https://deno.land/benchmarks)
- [Ultra](https://ultrajs.dev/)

### Bun

![SS](https://ss.yusukebe.com/26d3d33bde5455b3373698c0bd3b18e675c233ee9f338ec1c4dd107ed5147d88_800x449.png)

- https://www.youtube.com/watch?v=BsnCpESUEqM&t=358s

### Awesome Hono

- [Awesome Hono](https://awesome-hono.y-nkt.workers.dev/)

### Honoã‚’ä½¿ã†ã¹ãã‹ï¼Ÿ

ãƒ™ãƒ³ãƒãƒãƒ¼ã‚¯

## 3.4 5ã¤ã®ç‰¹å¾´

- é€Ÿã„ ğŸš€ - RegExpRouterã¯ãƒã‚¸ã§é€Ÿã„ã€‚ãƒªãƒ‹ã‚¢ã«ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã—ã¾ã›ã‚“ã€‚
- è»½é‡ ğŸª¶ - `hono/tiny`ãƒ—ãƒªã‚»ãƒƒãƒˆã¯12kBã€‚Honoã¯Web Standard APIã®ã¿ã‚’ä½¿ã£ã¦ã„ã¦ä¾å­˜0ã€‚
- ãƒãƒ«ãƒãƒ©ãƒ³ã‚¿ã‚¤ãƒ  ğŸŒ - Cloudflare Workers, Fastly Compute@Edge, Deno, Bun, Lagon, AWS Lambda, or Node.jsã€‚åŒã˜ã‚³ãƒ¼ãƒ‰ãŒå…¨ã¦ã®ãƒ©ãƒ³ã‚¿ã‚¤ãƒ /ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ ã§å‹•ãã¾ã™ã€‚
- æƒã£ã¦ã„ã‚‹ ğŸ”‹ - Honoã«ã¯ãƒ“ãƒ«ãƒˆã‚¤ãƒ³ãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢ã€ã‚«ã‚¹ã‚¿ãƒ ãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢ã€3rdãƒ‘ãƒ¼ãƒ†ã‚£ãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢ãŒã‚ã‚Šã¾ã™ã€‚ã‚„ã‚ŠãŸã„ã“ã¨ãŒæƒã£ã¦ã„ã¾ã™ã€‚
- æ¥½ã—ã„DX ğŸ› ï¸ - ç¶ºéº—ãªAPIã€‚ãã—ã¦TypeScriptã®ã‚µãƒãƒ¼ãƒˆã€‚ãã†å‹ãŒã‚ã‚‹ã®ã§ã™ã€‚

## 3.5 é€Ÿã„

- 5ã¤ã®ãƒ«ãƒ¼ã‚¿ãƒ¼ã‚’å‚™ãˆã¦ã„ã‚‹
- RegExpRouter - ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã‚’ã²ã¨ã¤ã®å¤§ããªæ­£è¦è¡¨ç¾ã«ã™ã‚‹ã€‚JavaScriptç•Œã§ã»ã¼æœ€é€Ÿ
- TriRouter - Trieæœ¨ã‚’åˆ©ç”¨ã€‚ãƒªãƒ•ã‚¡ãƒ¬ãƒ³ã‚¹å®Ÿè£…
- SmartRouter - ç™»éŒ²ã•ã‚ŒãŸãƒ«ãƒ¼ã‚¿ãƒ¼ã®ä¸­ã‹ã‚‰æœ€é©ãªãƒ«ãƒ¼ã‚¿ãƒ¼ã‚’è‡ªå‹•çš„ã«é¸ã¶
- LinearRouter - ç™»éŒ²ãŒæœ€é€Ÿ
- PatternRouter - ä¸€ç•ªã‚µã‚¤ã‚ºãŒå°ã•ã„ã€‚1.3KB

### RegExpRouter

- RegExpRouterã¯ã€ŒRegExpã€ã¨ã„ã£ã¦ã‚‚Expressãªã©ã§ä½¿ã‚ã‚Œã¦ã„ã‚‹[path-to-regexp](https://github.com/pillarjs/path-to-regexp)ã¨ã¯é•ã†
- path-to-regexpã¯ãƒªãƒ‹ã‚¢ã«ãƒãƒƒãƒã•ã›ã‚‹ã®ã§ã€ãƒ«ãƒ¼ãƒˆã”ã¨ã«æ­£è¦è¡¨ç¾ãŒèµ°ã‚‹

![SS](https://hono.dev/images/router-linear.jpg)

- RegExpRouterã¯äºˆã‚ä¸€ã¤ã®å¤§ããªæ­£è¦è¡¨ç¾ã‚’ä½œã‚Šä¸€åº¦ã§ãƒãƒƒãƒã•ã›ã‚‹

![SS](https://hono.dev/images/router-regexp.jpg)

### TriRouter

- Trieæœ¨ã®æ§‹é€ ã‚’ä½¿ã£ãŸãƒ«ãƒ¼ã‚¿ãƒ¼
- ãƒªãƒ‹ã‚¢ã«ãƒãƒƒãƒã•ã›ã‚‹ã‚ˆã‚Šé€Ÿã„ãŒã€Honoã®ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã®éƒ½åˆä¸Šã€ä¸€èˆ¬çš„ãªæœ¨æ§‹é€ ã®ãƒ«ãƒ¼ã‚¿ãƒ¼ã¨æ¯”ã¹ã‚‹ã¨é…ã„
- ã“ã®ãƒ«ãƒ¼ã‚¿ãƒ¼ã‚’æ­£ã¨ã™ã‚‹ã€ãƒªãƒ•ã‚¡ãƒ¬ãƒ³ã‚¹å®Ÿè£…ã«ãªã£ã¦ã„ã‚‹

![SS](https://hono.dev/images/router-tree.jpg)

### SmartRouter

- è¤‡æ•°ã®ãƒ«ãƒ¼ã‚¿ãƒ¼ã‚’ç™»éŒ²ã—ã¦ãŠãã¨ã€ãã®ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã«æœ€é©ãªãƒ«ãƒ¼ã‚¿ãƒ¼ã‚’é¸ã‚“ã§ãã‚Œã‚’ä½¿ã„ç¶šã‘ã‚‹

```ts
readonly defaultRouter: Router = new SmartRouter({
  routers: [new RegExpRouter(), new TrieRouter()],
})
```

### LinearRouter

- ç™»éŒ²ãŒé€Ÿã„

```txt
â€¢ GET /user/lookup/username/hey
----------------------------------------------------- -----------------------------
LinearRouter     1.82 Âµs/iter      (1.7 Âµs â€¦ 2.04 Âµs)   1.84 Âµs   2.04 Âµs   2.04 Âµs
MedleyRouter     4.44 Âµs/iter     (4.34 Âµs â€¦ 4.54 Âµs)   4.48 Âµs   4.54 Âµs   4.54 Âµs
FindMyWay       60.36 Âµs/iter      (45.5 Âµs â€¦ 1.9 ms)  59.88 Âµs  78.13 Âµs  82.92 Âµs
KoaTreeRouter    3.81 Âµs/iter     (3.73 Âµs â€¦ 3.87 Âµs)   3.84 Âµs   3.87 Âµs   3.87 Âµs
TrekRouter       5.84 Âµs/iter     (5.75 Âµs â€¦ 6.04 Âµs)   5.86 Âµs   6.04 Âµs   6.04 Âµs

summary for GET /user/lookup/username/hey
  LinearRouter
   2.1x faster than KoaTreeRouter
   2.45x faster than MedleyRouter
   3.21x faster than TrekRouter
   33.24x faster than FindMyWay
```

### PatternRouter

- ã¨ã«ã‹ãå°ã•ã„

![SS](https://ss.yusukebe.com/b4a1395baf72b62eb4b904c1cc1b140f3479b8a64a209740b9f51c77b3834d30_800x276.png)

### ãƒ™ãƒ³ãƒãƒãƒ¼ã‚¯

- https://github.com/honojs/hono/tree/main/benchmarks/routers

å¯¾è±¡ã®ãƒ«ãƒ¼ã‚¿ãƒ¼

- [find-my-way](https://github.com/delvedor/find-my-way)  
- [express](https://www.npmjs.com/package/express)  
- [koa-router](https://github.com/alexmingoia/koa-router)  
- [koa-tree-router](https://github.com/steambap/koa-tree-router)  
- [trek-router](https://www.npmjs.com/package/trek-router)  
- [@medley/router](https://www.npmjs.com/package/@medley/router)  
- [Memoirist](https://github.com/saltyaom/memoirist)  
- [Hono RegExpRouter](https://github.com/honojs/hono)  
- [Hono TrieRouter](https://github.com/honojs/hono)  

çµæœ

```txt
â€¢ all together
---------------------------------------------------------------------------- -----------------------------
Hono RegExpRouter                      460.6 ns/iter (429.69 ns â€¦ 525.88 ns)  479.5 ns 520.63 ns 525.88 ns
Hono TrieRouter                         1.52 Âµs/iter     (1.39 Âµs â€¦ 1.73 Âµs)   1.56 Âµs   1.73 Âµs   1.73 Âµs
@medley/router                        618.21 ns/iter (591.08 ns â€¦ 764.25 ns) 636.08 ns 764.25 ns 764.25 ns
find-my-way                           959.15 ns/iter   (892.79 ns â€¦ 1.02 Âµs) 979.02 ns   1.02 Âµs   1.02 Âµs
koa-tree-router                       926.79 ns/iter   (866.17 ns â€¦ 1.04 Âµs) 943.57 ns   1.04 Âµs   1.04 Âµs
trek-router                             1.76 Âµs/iter     (1.69 Âµs â€¦ 1.84 Âµs)   1.79 Âµs   1.84 Âµs   1.84 Âµs
express (WARNING: includes handling)    4.02 Âµs/iter      (3.9 Âµs â€¦ 4.33 Âµs)   4.06 Âµs   4.33 Âµs   4.33 Âµs
koa-router                              1.39 Âµs/iter     (1.34 Âµs â€¦ 1.57 Âµs)   1.41 Âµs   1.57 Âµs   1.57 Âµs
radix3                                763.26 ns/iter (734.77 ns â€¦ 902.52 ns)  781.2 ns 902.52 ns 902.52 ns
Memoirist                             540.11 ns/iter (507.38 ns â€¦ 699.65 ns) 554.52 ns 697.25 ns 699.65 ns

summary for all together
  Hono RegExpRouter
   1.17x faster than Memoirist
   1.34x faster than @medley/router
   1.66x faster than radix3
   2.01x faster than koa-tree-router
   2.08x faster than find-my-way
   3.02x faster than koa-router
   3.3x faster than Hono TrieRouter
   3.82x faster than trek-router
   8.74x faster than express (WARNING: includes handling)
```

### @usualomaã•ã‚“

RegExpRouter, SmartRouter, LinearRouter, PatternRouterã¯ [@usualomaã•ã‚“](https://github.com/usualoma) ãŒä½œã‚Šã¾ã—ãŸã€‚
@usualomaã•ã‚“ãŒç™ºè¡¨ã—ãŸè³‡æ–™ãŒå‚è€ƒã«ãªã‚Šã¾ã™ã€‚

[![SS](https://ss.yusukebe.com/3d83d51c90264dee2d949cfeec7d1d5739f96adca5519fb8fc64d39546365536_800x437.png)](https://speakerdeck.com/usualoma/honono3-plus-1norutatosokonitunagaruprgapuroziekutonimotarasitamono)

- [Honoã®3+1ã®ãƒ«ãƒ¼ã‚¿ãƒ¼ã¨ãã“ã«ã¤ãªãŒã‚‹PRãŒãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã«ã‚‚ãŸã‚‰ã—ãŸã‚‚ã® - Speaker Deck](https://speakerdeck.com/usualoma/honono3-plus-1norutatosokonitunagaruprgapuroziekutonimotarasitamono)

## 3.6 è»½é‡

- æ¨™æº–ã§21KBã€PatternRouterã§13KB
- ã¡ãªã¿ã«Expressã¯572KB
- Web Standardã®APIã®ã¿ã‚’ä½¿ã£ã¦ã„ã¦ã€å¤–éƒ¨ã®ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã¸ã®ä¾å­˜ãŒ0ã€‚

### ãƒ—ãƒªã‚»ãƒƒãƒˆ

ã‚ã‚‰ã‹ã˜ã‚ã€ãŠã™ã™ã‚ã®ãƒ«ãƒ¼ã‚¿ãƒ¼ã®ã‚»ãƒƒãƒ†ã‚£ãƒ³ã‚°ã‚’ãƒ—ãƒªã‚»ãƒƒãƒˆã¨ã—ã¦æä¾›ã—ã¦ã„ã‚‹ã€‚

> - `hono`:
>   ã»ã¨ã‚“ã©ã®ãƒ¦ãƒ¼ã‚¹ã‚±ãƒ¼ã‚¹ã§ã‚ªã‚¹ã‚¹ãƒ¡ã§ã™ã€‚ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ç™»éŒ²ãŒ`hono/quick`ã‚ˆã‚Šé…ã„ã¨ã¯ã„ãˆã€ä¸€åº¦ç™»éŒ²ã•ã‚Œã‚Œã°é«˜ã„ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã‚’ç™ºæ®ã—ã¾ã™ã€‚**Deno**ã‚„**Bun**ã€ãã‚Œã«**Node.js**ãªã©ã‚’ä½¿ã£ãŸå¸¸é§å‹ã®ã‚µãƒ¼ãƒãƒ¼ã«ã¯æœ€é©ã§ã™ã€‚ã¾ãŸã€**Cloudflare Workers**ã‚„**Deno Deploy**ã€**Lagon**ã§ã‚‚ã“ã®ãƒ—ãƒªã‚»ãƒƒãƒˆã‚’ä½¿ãˆã°ã„ã„ã§ã—ã‚‡ã†ã€‚ã¨ã„ã†ã®ã‚‚ã“ã‚Œã‚‰ã®ã‚ˆã†ãªv8 isolateã‚’ä½¿ã£ãŸç’°å¢ƒã§ã¯ã€isolateã¯èµ·å‹•å¾Œã—ã°ã‚‰ãè¡Œãç¶šã‘ã‚‹ã‹ã‚‰ã§ã™ï¼ˆæ™‚é–“ãŒæ±ºã¾ã£ã¦ã„ãŸã‚Šã€ãƒ¡ãƒ¢ãƒªãªã©ã®çŠ¶æ³ã«å¿œã˜ã¦å¤‰åŒ–ã—ãŸã‚Šã—ã¾ã™ï¼‰ã€‚
> 
> - `hono/quick`:
>   ã“ã®ãƒ—ãƒªã‚»ãƒƒãƒˆã¯ãƒªã‚¯ã‚¨ã‚¹ãƒˆã®ãŸã³ã«ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãŒåˆæœŸåŒ–ã•ã‚Œã‚‹ã‚ˆã†ãªç’°å¢ƒã«é©ã—ã¦ã„ã¾ã™ã€‚**Fastly Compute@Edge**ã¯ã“ã‚Œã«å¾“ã†ã®ã§ã€ã“ã®ãƒ—ãƒªã‚»ãƒƒãƒˆã‚’ä½¿ã†ã¨ã„ã„ã§ã—ã‚‡ã†ã€‚
>
> - `hono/tiny`:
>   ã“ã®ãƒ—ãƒªã‚»ãƒƒãƒˆã¯ä¸€ç•ªãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚ºã®å°ã•ã„ãƒ—ãƒªã‚»ãƒƒãƒˆã§ã™ã€‚ãƒªã‚½ãƒ¼ã‚¹ãŒé™ã‚‰ã‚Œã¦ã„ã‚‹ç’°å¢ƒã«ã¯ã„ã„ã§ã—ã‚‡ã†ã€‚

## 3.7 ã©ã“ã§ã‚‚å‹•ã

### Web Standard APIs

- Webæ¨™æº–ã®APIã®ã¿ã‚’ä½¿ç”¨
- Node.jsã‚¢ãƒ€ãƒ—ã‚¿ãƒ¼ã¯Node.jsã®incoming/outgoingã‚’Request/Responseã«å¤‰æ›ã—ã¦ã„ã‚‹
- [WinterCG](https://wintercg.org/)ã‚’ãƒ•ã‚©ãƒ­ãƒ¼ã—ã¦ã„ã‚‹

### æœ€ä½é™ã®ã‚³ãƒ¼ãƒ‰

```ts
export default {
  async fetch() {
    return new Response('Hello World')
  },
}
```

#### ã‚ˆãä½¿ã†API

- `Request`
- `Response`
- `URL`
- `URLSearchParams`
- `Headers`
- `FormData`
- [Web API | MDN](https://developer.mozilla.org/ja/docs/Web/API)

#### é¢ç™½ã„API

- [`URLPattern`](https://developer.mozilla.org/en-US/docs/Web/API/URLPattern)
  - ã“ã‚Œã‚’åˆ©ç”¨ã—ã¦ãƒ«ãƒ¼ã‚¿ãƒ¼ã‚’ä½œã£ãŸ
  - [yusukebe/pico: Ultra-tiny router for Cloudflare Workers and Deno](https://github.com/yusukebe/pico)
  - path-to-regexpã¨ä¼¼ãŸå®Ÿè£…
  - Bunã«ã¯ãªã„

### ã‚¹ã‚¿ãƒ¼ã‚¿ãƒ¼ã®ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã¯12ç¨®é¡

1. aws-lambda
2. bun
3. cloudflare-pages
4. cloudflare-workers
5. deno
6. fastly
7. lagon
8. lambda-edge
9. netlify
10. nextjs
11. nodejs
12. vercel

### CIã§ã¯9ç¨®é¡ã®ãƒ©ãƒ³ã‚¿ã‚¤ãƒ ã®ãƒ†ã‚¹ãƒˆãŒèµ°ã‚‹

![CI](https://ss.yusukebe.com/78b00758a08ac5d798648c403d9793ca0b84d45fb80fccc801628ce1fb9325c2_800x639.png)

### ã‚¨ãƒ³ãƒˆãƒªãƒã‚¤ãƒ³ãƒˆãŒé•ã†ã ã‘

#### Cloudflare Workers & Bun

```ts
import { Hono } from 'hono'
const app = new Hono()

app.get('/', (c) => c.text('Hello Hono!'))

export default app
```

#### Fastly Compute@Edge

```ts
import { Hono } from 'hono'
const app = new Hono()

app.get('/', (c) => c.text('Hello Hono!'))

app.fire()
```

#### Deno

```ts
import { Hono } from 'https://deno.land/x/hono@vv3.7.1/mod.ts'

const app = new Hono()

app.get('/', (c) => c.text('Hello Hono!'))

Deno.serve(app.fetch)
```

#### Lagon

```ts
import { Hono } from 'hono'
const app = new Hono()

app.get('/', (c) => c.text('Hello Hono!'))

export const handler = app.fetch
```

#### Cloudflare Pages

```ts
import { Hono } from 'hono'
import { handle } from 'hono/cloudflare-pages'

const app = new Hono()

app.get('/', (c) => c.text('Hello Hono!'))

export const onRequest = handle(app)
```

#### Vercel

```ts
import { Hono } from 'hono'
import { handle } from 'hono/vercel'

export const config = {
  runtime: 'edge',
}

const app = new Hono()

app.get('/', (c) => c.text('Hello Hono!'))

export default handle(app)
```

#### Netlify

```ts
import { handle } from 'https://deno.land/x/hono@v3.7.1/adapter/netlify/mod.ts'
import { Hono } from 'https://deno.land/x/hono@v3.7.1/mod.ts'

const app = new Hono()

app.get('/', (c) => c.text('Hello Hono!'))

export default handle(app)
```

#### AWS Lambda

```ts
import { Hono } from 'hono'
import { handle } from 'hono/aws-lambda'

const app = new Hono()

app.get('/', (c) => c.text('Hello Hono!'))

export const handler = handle(app)
```

#### Lambda@Edge

```ts
import { Hono } from 'hono'
import { handle } from 'hono/lambda-edge'

const app = new Hono()

app.get('/', (c) => c.text('Hello Hono!'))

export const handler = handle(app)
```

#### Node.js

```ts
import { serve } from '@hono/node-server'
import { Hono } from 'hono'

const app = new Hono()

app.get('/', (c) => c.text('Hello Hono!'))

serve(app)
```


## 3.8 æƒã£ã¦ã„ã‚‹

ã‚³ã‚¢ã¯å°ã•ã„ãŒã€ãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢ã¨ãƒ˜ãƒ«ãƒ‘ãƒ¼ãŒã‚ã‚‹ã€‚

### ãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢

- `Response`ã‚’è¿”ã™ã‚‚ã®ã‚’ã€Œãƒãƒ³ãƒ‰ãƒ©ã€ã¨å‘¼ã‚“ã§ã„ã‚‹
- ãã®å‰å¾Œã«å®Ÿè¡Œã•ã‚Œã€`Request`ã¨`Response`ã‚’æ‰±ã†ã®ãŒãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢

![onion](https://hono.dev/images/onion.png)

- Honoã®ã‚¢ãƒ—ãƒªã‚’æ§‹æˆã™ã‚‹ã®ã¯ãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢ã¨ãƒãƒ³ãƒ‰ãƒ©ã ã‘

### 3ã¤ã®ãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢

- ãƒ“ãƒ«ãƒˆã‚¤ãƒ³ãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢ã€3rdãƒ‘ãƒ¼ãƒ†ã‚£ãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢ã€ã‚«ã‚¹ã‚¿ãƒ ãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢ãŒã‚ã‚‹

### ãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢ã¨ãƒ˜ãƒ«ãƒ‘ãƒ¼ã®ä¾‹

- [Basic Authentication](https://hono.dev/middleware/builtin/basic-auth)
- [Bearer Authentication](https://hono.dev/middleware/builtin/bearer-auth)
- [Cache](https://hono.dev/middleware/builtin/cache)
- [Compress](https://hono.dev/middleware/builtin/compress)
- [Cookie](https://hono.dev/helpers/cookie)
- [CORS](https://hono.dev/middleware/builtin/cors)
- [ETag](https://hono.dev/middleware/builtin/etag)
- [html](https://hono.dev/helpers/html)
- [JSX](https://hono.dev/guides/jsx)
- [JWT Authentication](https://hono.dev/middleware/builtin/jwt)
- [Logger](https://hono.dev/middleware/builtin/logger)
- [Pretty JSON](https://hono.dev/middleware/builtin/pretty-json)
- [Secure Headers](https://hono.dev/middleware/builtin/secure-headers)
- [GraphQL Server](https://github.com/honojs/middleware/tree/main/packages/graphql-server)
- [Firebase Authentication](https://github.com/honojs/middleware/tree/main/packages/firebase-auth)
- [Sentry](https://github.com/honojs/middleware/tree/main/packages/sentry)
- Others!

### ã‚«ã‚¹ã‚¿ãƒ ãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢

- `X-Response-Time`ãƒ˜ãƒƒãƒ€ã‚’ä»˜ä¸ã™ã‚‹ãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢

```ts
app.use('*', async (c, next) => {
  const start = Date.now()
  await next()
  const end = Date.now()
  c.res.headers.set('X-Response-Time', `${end - start}`)
})
```

### JSX

- çµ„ã¿è¾¼ã¿ã®JSXãŒä½¿ãˆã‚‹

```tsx
import type { FC } from 'hono/jsx'

const app = new Hono()

const Layout: FC = (props) => {
  return (
    <html>
      <body>{props.children}</body>
    </html>
  )
}

const Top: FC<{ messages: string[] }> = (props: { messages: string[] }) => {
  return (
    <Layout>
      <h1>Hello Hono!</h1>
      <ul>
        {props.messages.map((message) => {
          return <li>{message}!!</li>
        })}
      </ul>
    </Layout>
  )
}

app.get('/', (c) => {
  const messages = ['Good Morning', 'Good Evening', 'Good Night']
  return c.html(<Top messages={messages} />)
})
```

## 3.8 æ¥½ã—ã„DX

### TypeScript

- Honoã§ã¯ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’TypeScriptã§æ›¸ãã“ã¨ã‚’æ¨å¥¨ã—ã¦ã„ã‚‹
- Cloudflare Workersã€Denoã€Bunã¯TSã‹ã‚‰JSã¸ã®ãƒˆãƒ©ãƒ³ã‚¹ãƒ‘ã‚¤ãƒ«ã‚’æ„è­˜ã™ã‚‹å¿…è¦ãŒãªã„

![SS](https://hono.dev/images/ss.png)

### RPC

- ã‚µãƒ¼ãƒãƒ¼å´ã®å‹ã‚’å…±æœ‰ã—ã€ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã§ã‚‚åˆ©ç”¨ã™ã‚‹ã“ã¨ã§Type-Safeã«ã™ã‚‹
- [tRPC](https://trpc.io/)ã‚ˆã‚Šã‚«ã‚¸ãƒ¥ã‚¢ãƒ«ã«ä½¿ãˆã‚‹
- [Zod](https://zod.dev/)ã€[Zod Validator](https://github.com/honojs/middleware/tree/main/packages/zod-validator)ã€`hc` ã‚’ä½¿ã£ãŸã‚¹ã‚¿ãƒƒã‚¯ãŒã‚ã‚‹

#### APIã‚’æ›¸ã

```ts
import { Hono } from 'hono'

const app = new Hono()

app.get('/hello', (c) => {
  return c.json({
    message: `Hello!`,
  })
})
```

#### Zodã§ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ã™ã‚‹

![SC](https://hono.dev/images/sc01.gif)

```ts
import { zValidator } from '@hono/zod-validator'
import { z } from 'zod'

app.get(
  '/hello',
  zValidator(
    'query',
    z.object({
      name: z.string(),
    })
  ),
  (c) => {
    const { name } = c.req.valid('query')
    return c.json({
      message: `Hello! ${name}`,
    })
  }
)
```

#### å‹ã‚’å…±æœ‰ã™ã‚‹

- `c.json()`ã‚’`c.jsonT()`ã«ã™ã‚‹
- è¿”ã‚Šå€¤ã®å‹ã‚’ã¨ã‚‹

![SC](https://hono.dev/images/sc02.gif)

```ts
const route = app.get(
  '/hello',
  zValidator(
    'query',
    z.object({
      name: z.string(),
    })
  ),
  (c) => {
    const { name } = c.req.valid('query')
    return c.jsonT({
      message: `Hello! ${name}`,
    })
  }
)

export type AppType = typeof route
```

#### ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã®å®Ÿè£…

- `hc()` ã§ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã®ä½œæˆ
- ã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰ã®å‹ã‚’ã‚¸ã‚§ãƒãƒªã‚¯ã‚¹ã§æ¸¡ã™
- URLã®ãƒ‘ã‚¹ã¨ãƒªã‚¯ã‚¨ã‚¹ãƒˆã®ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã®è£œå®ŒãŒåŠ¹ã

![SC](https://hono.dev/images/sc03.gif)

```ts
import { AppType } from './server'
import { hc } from 'hono/client'

const client = hc<AppType>('/api')
const res = await client.hello.$get({
  query: {
    name: 'Hono',
  },
})
```

- ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã¯`Response`ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆãªã®ã§ãã®ã¾ã¾ä½¿ãˆã‚‹
- ãŸã ã—ã€`json()`ã§å–ã‚Šå‡ºã—ãŸã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã«ã¯å‹ãŒã¤ã

![SC](https://hono.dev/images/sc04.gif)

```ts
const data = await res.json()
console.log(`${data.message}`)
```

- APIã®å‹ã‚’å…±æœ‰ã™ã‚‹ã“ã¨ã§ã€ã‚µãƒ¼ãƒãƒ¼ã‚µã‚¤ãƒ‰ã®å¤‰åŒ–ã‚’ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã§æ°—ã¥ãã“ã¨ã«ãªã‚‹

![SS](https://hono.dev/images/ss03.png)

### ãƒ†ã‚¹ãƒˆ

- ãƒ†ã‚¹ãƒˆãŒç°¡å˜ã«æ›¸ã‘ã‚‹

```ts
describe('Example', () => {
  test('GET /posts', async () => {
    const res = await app.request('/posts')
    expect(res.status).toBe(200)
    expect(await res.text()).toBe('Many posts')
  })
})
```

- Testing Helperã§`hc`ãŒä½¿ãˆã‚‹

![output](https://github.com/yusukebe/sonik/assets/10682/60442c8e-1640-4131-b09e-d57b6e5f350c)

```ts
import { testClient } from 'hono/testing'

it('test', async() => {
  const app = new Hono().get('/search', (c) => c.jsonT({ hello: 'world' }))
  const res = await testClient(app).search.$get()

  expect(await res.json()).toEqual({ hello: 'world' })
})
```

## 3.10 Cloudflare + Hono ã‚’ä½¿ã£ãŸã‚¢ãƒ—ãƒªä¾‹

### r2-image-worker

- [yusukebe/r2-image-worker](https://github.com/yusukebe/r2-image-worker)

![SC](https://user-images.githubusercontent.com/10682/167978838-b3ef2d72-81ac-4058-b161-ccb2b4f0bc16.gif)

# 4. åŸºæœ¬ç·¨

## 4.1 åˆã‚ã¦ã®Cloudflare Workers

### C3ã‚’ä½¿ã†

- Create Cloudflare CLI

```txt
npm create cloudflare@latest

Or

yarn create cloudflare

Or

pnpm create cloudflare@latest

Or

bun create cloudflare
```

### "Hello World" Worker

### `package.json`

```json
{
  "name": "curly-leaf-e7ce",
  "version": "0.0.0",
  "private": true,
  "scripts": {
    "deploy": "wrangler deploy",
    "start": "wrangler dev"
  },
  "devDependencies": {
    "@cloudflare/workers-types": "^4.20230419.0",
    "typescript": "^5.0.4",
    "wrangler": "^3.0.0"
  }
}
```

### `src/index.ts`

```ts
export interface Env {}

// ExportedHandler
export default {
  async fetch(request: Request, env: Env, ctx: ExecutionContext): Promise<Response> {
    return new Response('Hello World!')
  },
}
```

### `fetch`ã®å¼•æ•°

- `request` - `Request`ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ
- `env` - Bindingsã®åå‰ã¨å€¤ã®ãƒ¬ã‚³ãƒ¼ãƒ‰
- `ctx` - `ExecutionContext`ã€ã¤ã¾ã‚Š`waitUntil()`ã¨`passThroughOnException()`

### Workersã‚¢ãƒ—ãƒªã®æµã‚Œ

1. Requestã‚’å—ã‘å–ã‚‹
2. ãƒ­ã‚¸ãƒƒã‚¯
3. Responseã‚’ä½œã‚‹
4. Responseã‚’è¿”ã™

### `waitUntil()`

```ts
export default {
  async fetch(_req, _env, ctx) {
    const log = async () => console.log('Foo')
    ctx.waitUntil(log())
    return new Response('Hello')
  },
} as ExportedHandler
```

## 4.2 åˆã‚ã¦ã®Hono

### `create hono`

```txt
npm create hono@latest

Or

yarn create hono

Or

pnpm create hono@latest

Or

bun create hono
```

### ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’è¿”ã™

```ts
app.get('/', (c) => {
  return c.text('Hello!')
})

app.get('/json', (c) => {
  return c.json({
    message: 'Hello!',
  })
})

app.get('/html', (c) => {
  return c.json({
    message: '<h1>Hello!</h1>',
  })
})

app.get('/stream', (c) => {
  return c.streamText(async (stream) => {
    stream.sleep(1000)
    stream.writeln('Hello!')
  })
})
```

Contextã‚’é€šã—ã¦ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’ä½œã‚‹

```ts
app.get('/welcome', (c) => {
  // Set headers
  c.header('X-Message', 'Hello!')
  c.header('Content-Type', 'text/plain')

  // Set HTTP status code
  c.status(201)

  // Return the response body
  return c.body('Thank you for coming')
})
```

ä»¥ä¸‹ã¨åŒã˜

```ts
new Response('Thank you for coming', {
  status: 201,
  headers: {
    'X-Message': 'Hello',
    'Content-Type': 'text/plain',
  },
})
```

ãã®ä»–

- `c.notFound()`
- `c.redirect()`

### ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°

```ts
// HTTP Methods
app.get('/', (c) => c.text('GET /'))
app.post('/', (c) => c.text('POST /'))
app.put('/', (c) => c.text('PUT /'))
app.delete('/', (c) => c.text('DELETE /'))

// Wildcard
app.get('/wild/*/card', (c) => {
  return c.text('GET /wild/*/card')
})

// Any HTTP methods
app.all('/hello', (c) => c.text('Any Method /hello'))

// Custom HTTP method
app.on('PURGE', '/cache', (c) => c.text('PURGE Method /cache'))

// Multiple Method
app.on(['PUT', 'DELETE'], '/post', (c) => c.text('PUT or DELETE /post'))

// Path parameters
app.get('/user/:name', (c) => {
  const name = c.req.param('name')
  ...
})

// Optional parameters
// Will match `/api/animal` and `/api/animal/:type`
app.get('/api/animal/:type?', (c) => c.text('Animal!'))

// Regexp
app.get('/post/:date{[0-9]+}/:title{[a-z]+}', (c) => {
  const { date, title } = c.req.param()
  ...
})

// Including a slash
app.get('/posts/:filename{.+.png$}', (c) => {
  //...
})

// Chained routes
app
  .get('/endpoint', (c) => {
    return c.text('GET /endpoint')
  })
  .post((c) => {
    return c.text('POST /endpoint')
  })
  .delete((c) => {
    return c.text('DELETE /endpoint')
  })
```

ãƒ«ãƒ¼ãƒˆã‚’åˆ†ã‘ã‚‹

```ts
const book = new Hono()

book.get('/', (c) => c.text('List Books')) // GET /book
book.get('/:id', (c) => {
  // GET /book/:id
  const id = c.req.param('id')
  return c.text('Get Book: ' + id)
})
book.post('/', (c) => c.text('Create Book')) // POST /book

const app = new Hono()
app.route('/book', book)
```

ãƒ›ã‚¹ãƒˆåã§ã®ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°

```ts
const app = new Hono({
  getPath: (req) => req.url.replace(/^https?:\/(.+?)$/, '$1'),
})

app.get('/www1.example.com/hello', (c) => c.text('hello www1'))
app.get('/www2.example.com/hello', (c) => c.text('hello www2'))
```

### Context

Bindingsã®å–å¾—

```ts
// Environment object for Cloudflare Workers
app.get('*', async c => {
  const counter = c.env.COUNTER
  ...
})
```

`c.set()` / `c.get()`

```ts
app.use('*', async (c, next) => {
  c.set('message', 'Hono is cool!!')
  await next()
})

app.get('/', (c) => {
  const message = c.get('message')
  return c.text(`The message is "${message}"`)
})
```

`Variable`ã‚’`app`ã¸æ¸¡ã™ã“ã¨ã§å‹ãŒã¤ã

```ts
type Variables = {
  message: string
}

const app = new Hono<{ Variables: Variables }>()
```

`c.var`

`c.set()`ã§ã‚»ãƒƒãƒˆã—ãŸå¤‰æ•°ã¸ã‚¢ã‚¯ã‚»ã‚¹ã§ãã‚‹

```ts
const result = c.var.client.oneMethod()
```

ãã®ä»–

- `c.executionCtx`
- `c.event`
- `c.error`

### HonoRequest

- `param()`
- `query()`
- `queries()`
- `header()`
- `parseBody()`
- `json()`
- `text()`
- `arrayBuffer()`
- `valid()`
- `path`
- `url`
- `method`
- `raw`

# 5. ãƒ—ãƒ­ã‚­ã‚·ç·¨

[Cloudflare Workersãƒ—ãƒ­ã‚­ã‚·ãƒ‘ã‚¿ãƒ¼ãƒ³](https://zenn.dev/yusukebe/articles/647aa9ba8c1550)ã‚’ã‚„ã‚‹

## ãƒ¬ã‚¹ãƒãƒ³ã‚¹ãƒ˜ãƒƒãƒ€ã®è¿½åŠ 

```ts
import { Hono } from 'hono'

const app = new Hono()

app.all('*', async (c) => {
  const res = await fetch(c.req.raw)
  const newResponse = new Response(res.body, res)
  newResponse.headers.set('X-Custom', 'Foo')
  return newResponse
})

export default app
```

## CORS

```ts
app.use('/api/*', cors())
```

```ts
app.use(
  '/api2/*',
  cors({
    origin: 'http://example.com',
    allowHeaders: ['X-Custom-Header', 'Upgrade-Insecure-Requests'],
    allowMethods: ['POST', 'GET', 'OPTIONS'],
    exposeHeaders: ['Content-Length', 'X-Kuma-Revision'],
    maxAge: 600,
    credentials: true,
  })
)
```

## Basicèªè¨¼

```ts
app.use(
  '/auth/*',
  basicAuth({
    username: 'yourname',
    password: 'yoursecret',
  })
)
```

Cloudflareã®Bindingsã®å¤‰æ•°ã‚’ä½¿ã†å ´åˆ

```ts
app.use('/auth/*', async (c, next) => {
  const auth = basicAuth({
    username: c.env.USERNAME,
    password: c.env.PASSWORD,
  })
  return auth(c, next)
})
```

èªè¨¼ã¯ä»¥ä¸‹ã®ãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢ãŒã‚ã‚‹

- Basicèªè¨¼
- Bearerèªè¨¼
- JWTèªè¨¼

## ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ

```ts
app.get('/old/:id', async (c) => {
  const id = c.req.param('id')
  return c.redirect(`/new/${id}`)
})
```

## ã‚ªãƒªã‚¸ãƒ³ã®æŒ¯ã‚Šåˆ†ã‘

```ts
const imageHost = 'http://imagehost'
const fontHost = 'http://fonthost'

app.get('/assets/:type{(?:images|fonts)}/:filename', async (c) => {
  const { type, filename } = c.req.param()
  const hostName = type === 'images' ? imageHost : fontHost
  const url = new URL(`/${filename}`, hostName)
  return fetch(url)
})
```

## ã‚­ãƒ£ãƒƒã‚·ãƒ¥

```ts
app.get(
  '/assets/*',
  cache({
    cacheName: 'my-app',
  })
)
```

## ãƒ‡ãƒã‚¤ã‚¹åˆ¥ã®æŒ™å‹•å¤‰æ›´

```ts
app.get('/pages/*', async (c) => {
  let isMobile = false
  const userAgent = c.req.header('User-Agent') || ''

  if (userAgent.match(/(iPhone|iPod|Android|Mobile)/)) {
    isMobile = true
  }

  const cache = caches.default

  const device = isMobile ? 'Mobile' : 'Desktop'
  const cacheKey = c.req.url + '-' + device

  let response = await cache.match(cacheKey)

  if (!response) {
    response = await fetch(c.req.raw)
    response = new Response(response.body, response)
    response.headers.append('Cache-Control', 's-maxage=3600')
    c.executionCtx.waitUntil(cache.put(cacheKey, response.clone()))
  }

  return response
})
```

## HTMLã‚¿ã‚°ã®ç½®æ›

HTMLRewriterã‚’ä½¿ã†

```ts
app.get('/pages/*', async (c) => {
  const OLD_URL = 'oldhost'
  const NEW_URL = 'newhost'

  class AttributeRewriter {
    constructor(attributeName) {
      this.attributeName = attributeName
    }
    element(element) {
      const attribute = element.getAttribute(this.attributeName)
      if (attribute) {
        element.setAttribute(this.attributeName,
	  attribute.replace(OLD_URL, NEW_URL))
      }
    }
  }

  const rewriter = new HTMLRewriter().on('a', new AttributeRewriter('href'))

  const res = await fetch(c.req.raw)
  const contentType = res.headers.get('Content-Type')

  if (contentType.startsWith('text/html')) {
    return rewriter.transform(res)
  } else {
    return res
  }
})
```

## ãã®ä»–

- ãƒ›ãƒƒãƒˆãƒªãƒ³ã‚¯ç¦æ­¢
- 103 Early Hints
- å‹•çš„ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥
- [Cloudflare Workersãƒ—ãƒ­ã‚­ã‚·ãƒ‘ã‚¿ãƒ¼ãƒ³](https://zenn.dev/yusukebe/articles/647aa9ba8c1550)

# 6. Web APIç·¨

ä»¥ä¸‹åŸºæœ¬ã‚’ã‚„ã‚‹

- JSONã‚’è¿”ã™
- å¤‰æ•°ã‚’æ‰±ã†
- D1ã‚’ä½¿ã£ã¦ã¿ã‚ˆã†
- ãƒ­ã‚¸ãƒƒã‚¯
- ãƒ†ã‚¹ãƒˆã™ã‚‹
- ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³

## 6.1 Blog APIã‚’ã¤ãã£ã¦ã¿ã‚ˆã†

### é››å½¢ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰

```txt
npx degit yusukebe/cloudflare-workshop-examples/projects/starter-web-api starter-web-api
```

### ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹æˆ

```txt
$ tree ./
./
â”œâ”€â”€ blog.sql
â”œâ”€â”€ package.json
â”œâ”€â”€ src
â”‚Â Â  â””â”€â”€ index.ts
â”œâ”€â”€ test
â”‚Â Â  â””â”€â”€ index.test.ts
â”œâ”€â”€ tsconfig.json
â”œâ”€â”€ vitest.config.ts
â””â”€â”€ wrangler.sample.toml
```

### D1ã®è¨­å®š

```txt
wrangler d1 create blog
wrangler d1 execute blog --local --file ./blog.sql
wrangler d1 execute blog --local --command "INSERT INTO posts(id,title,content) VALUES('1','Hello','Nice day!')"
wrangler d1 execute blog --local --command "SELECT * FROM posts"
```

### `wrangler.toml`

```toml
name = "blog"
compatibility_date = "2023-01-01"

[[d1_databases]]
binding = "DB"
database_name = "blog"
database_id = ""

# [vars]
# MY_VARIABLE = "production_value"

# [[kv_namespaces]]
# binding = "MY_KV_NAMESPACE"
# id = "xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx"

# [[r2_buckets]]
# binding = "MY_BUCKET"
# bucket_name = "my-bucket"
```

```sql
CREATE TABLE posts (
  id TEXT PRIMARY KEY,
  created_at TEXT DEFAULT (datetime('now')),
  title TEXT,
  content TEXT
);
```

```txt
npm i zod @hono/zod-validator
```

### å…±é€šã§ä½¿ã†å‹

```ts
import { z } from 'zod'

const schema = z.object({
  title: z.string().min(1),
  content: z.string().min(1),
})

export type Bindings = {
  DB: D1Database
}
export type Post = z.infer<typeof schema> & {
  created_at: string
  id: string
}
```

### `GET /posts`ã®å®Ÿè£…

```ts
const { results } = await c.env.DB.prepare(
  'SELECT * FROM posts ORDER BY created_at DESC;'
).all<Post>()
```

- Bindingsã¸ã¯`c.env.DB`ã§ã‚¢ã‚¯ã‚»ã‚¹
- `all`ã¸`Post`å‹ã‚’ã‚¸ã‚§ãƒãƒªã‚¯ã‚¹ã§æ¸¡ã™

### `POST /posts`ã®å®Ÿè£…

Zod Validatorã‚’ä½¿ã†

```ts
import { zValidator } from '@hono/zod-validator'
// ...
app.post('/posts', zValidator('form', schema), async (c) => {
  const { title, content } = c.req.valid('form')
  // ...
})
```

UUIDã®ç”Ÿæˆ

```ts
const id = crypto.randomUUID()
```

Insertã®å®Ÿè¡Œ

```ts
const { success } = await c.env.DB.prepare(
  'INSERT INTO posts(id, title, content) values (?, ?, ?)'
)
  .bind(id, title, content)
  .run()
```

### ãƒ‡ãƒ—ãƒ­ã‚¤

```txt
npm run deploy
```

å®Ÿéš›ã¯Wranglerã‚’å®Ÿè¡Œã—ã¦ã„ã‚‹

```txt
wrangler deploy --minify src/index.ts
```

# 7. ãƒ•ãƒ«ã‚¹ã‚¿ãƒƒã‚¯ç·¨

- Pages
- Pagesã®ä»•çµ„ã¿ã«ã¤ã„ã¦
- JSX

## 7.1 Blogã®UIã‚‚ã¤ãã£ã¦ã¿ã‚ˆã†

### å®Œæˆå½¢

![SS](https://ss.yusukebe.com/078500973a75457b0bd771c6aeea9c48fc308d605f7c114314a1e24235f1165e_800x535.png)

### é››å½¢ã®ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰

```txt
npx degit yusukebe/cloudflare-workshop-examples/projects/starter-pages pages
```

### ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹é€ 

```txt
$ tree .
.
â”œâ”€â”€ front
â”‚Â Â  â”œâ”€â”€ App.tsx // Reactã‚¢ãƒ—ãƒª
â”‚Â Â  â””â”€â”€ main.tsx // ã‚¯ãƒ©ã‚¤ãƒ³ãƒˆã®ã‚¨ãƒ³ãƒˆãƒªãƒã‚¤ãƒ³ãƒˆ
â”œâ”€â”€ index.html // ã‚¨ãƒ³ãƒˆãƒªãƒã‚¤ãƒ³ãƒˆ
â”œâ”€â”€ package.json
â”œâ”€â”€ tsconfig.json
â”œâ”€â”€ vite.config.ts
â””â”€â”€ wrangler.sample.toml
```

### ãƒ—ãƒ­ã‚­ã‚·ã•ã›ã¦Viteã‚’ä½¿ã†

```txt
wrangler pages dev --compatibility-date=2023-01-01 -- vite
```

### Functionsã‚’ä½¿ã†

```ts
// functions/api/[[route]].ts
import { Hono } from 'hono'
import { handle } from 'hono/cloudflare-pages'
import app from '../../server'

const main = new Hono()
main.route('/api', app)

export const onRequest = handle(main)
```

### RPCãƒ¢ãƒ¼ãƒ‰ã‚’ä½¿ã†

```ts
// front/App.tsx
const client = hc<AppType>('/api')
const res = await client.posts.$get()
const { posts } = await res.json()
setPosts(posts)
```

## 7.2 SSRã§ã¤ãã£ã¦ã¿ã‚ˆã†

### å®Œæˆå“ã®ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰

```txt
npx degit yusukebe/cloudflare-workshop-examples/projects/ssr ssr
```

## 7.3 R2ç”»åƒã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ€ãƒ¼ã‚’ã¤ãã£ã¦ã¿ã‚ˆã†

### å®Œæˆå“ã®ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰

```txt
npx degit yusukebe/image-tag image-tag
```

### ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹æˆ

```txt
tree .
.
â”œâ”€â”€ .dev.vars
â”œâ”€â”€ .gitignore
â”œâ”€â”€ README.md
â”œâ”€â”€ package.json
â”œâ”€â”€ schema.sql
â”œâ”€â”€ src
â”‚Â Â  â”œâ”€â”€ index.tsx
â”‚Â Â  â””â”€â”€ renderer.ts
â”œâ”€â”€ tsconfig.json
â””â”€â”€ wrangler.toml
```

### R2ã®ãƒã‚±ãƒƒãƒˆã‚’ã¤ãã‚‹

```txt
npx wrangler r2 bucket create image-tag
```

### D1ã®ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚’ã¤ãã‚‹

ã‚¹ã‚­ãƒ¼ãƒ

```sql
CREATE TABLE images (
  id TEXT PRIMARY KEY,
  created_at TEXT DEFAULT (datetime('now')),
  tag TEXT
);
```

å®Ÿè¡Œ

```txt
npx wrangler d1 create image-tag
npx wrangler d1 execute image-tag --local --file=./schema.sql
```

### ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆã®ã¤ãã‚Šæ–¹

ãƒ­ãƒ¼ã‚«ãƒ«ã§ã¯`.dev.vars`ã«å€¤ã‚’å…¥ã‚Œã‚‹

```txt
BASIC_AUTH_USERNAME=foo
BASIC_AUTH_PASSWORD=bar
```

ãƒªãƒ¢ãƒ¼ãƒˆã§ã¯ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã‹ã‚‰ã‚„ã‚‹

### TSX

```
mv src/index.ts src/.index.tsx
```

### `src/renderer.ts`

```ts
import { Context } from 'hono'
import { html } from 'hono/html'

export const renderer = (c: Context) => (content: string) => {
  return c.html(html`<!DOCTYPE html>
    <html lang="en">
      <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@picocss/pico@1/css/pico.min.css" />
      </head>
      <body>
        <main class="container">${content}</main>
      </body>
    </html>`)
}
```

### `src/index.ts`

Bindings

```ts
type Bindings = {
  DB: D1Database
  BUCKET: R2Bucket
  BASIC_AUTH_USERNAME: string
  BASIC_AUTH_PASSWORD: string
}
```

`Image`

```ts
type Image = {
  id: string
  tag: string
  created_at: string
}
```

Rendererã®ç™»éŒ²

```ts
app.get('*', async (c, next) => {
  c.setRenderer(renderer(c))
  await next()
})
```

`POST /`

```ts
const schema = z.object({
  file: z.instanceof(File),
  tag: z.string().min(1)
})

app.post('/', zValidator('form', schema), async (c) => {
  const { file, tag } = c.req.valid('form')
  const id = crypto.randomUUID()
  if (file instanceof File) {
    const data = await file.arrayBuffer()
    const object = await c.env.BUCKET.put(id, data, {
      httpMetadata: {
        contentType: file.type
      }
    })
    if (object) {
      console.log(`${object.key} is uploaded!`)
      const { success } = await c.env.DB.prepare('INSERT INTO images(id,tag) VALUES(?,?)').bind(id, tag).run()
      if (!success) {
        return c.text('Something went wrong', 500)
      }
    }
  }
  return c.redirect('/')
})
```

`GET /file/:fileName`

```ts
app.get('/file/:fileName', async (c) => {
  const object = await c.env.BUCKET.get(c.req.param('fileName'))
  if (object) {
    c.header('content-type', object.httpMetadata?.contentType)
    return c.body(await object.arrayBuffer())
  }
  return c.notFound()
})
```

`GET /`

```ts
app.get('/', async (c) => {
  const { results } = await c.env.DB.prepare('SELECT * FROM images ORDER BY created_at DESC').all<Image>()
  const images = results

  return c.render(
    <>
      <h1>Top!</h1>
      <form method="POST" action="/" enctype="multipart/form-data">
        <input type="file" name="file" accept="image/*" />
        <input type="text" name="tag" />
        <button type="submit">Submit</button>
      </form>
      <div>
        {images.map((image) => {
          return (
            <div>
              <h3>{image.tag}</h3>
              <img src={`/file/${image.id}`} />
            </div>
          )
        })}
      </div>
    </>
  )
})
```

Basicèªè¨¼ã®ãŸã‚ã®ãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢

```ts
const myBasicAuth = middleware<{
  Bindings: Bindings
}>(async (c, next) => {
  const auth = basicAuth({
    username: c.env.BASIC_AUTH_USERNAME,
    password: c.env.BASIC_AUTH_PASSWORD
  })
  return await auth(c, next)
})
```

`GET /api/random`

```ts
const querySchema = z.object({
  tag: z.string().min(1)
})

app.get('/api/random', zValidator('query', querySchema), async (c) => {
  const { tag } = c.req.valid('query')
  const { results } = await c.env.DB.prepare('SELECT * FROM images WHERE tag = ? ORDER BY RANDOM() LIMIT 1')
    .bind(tag)
    .all<Image>()
  const images = results
  return c.json(images)
})
```

### ãƒ‡ãƒ—ãƒ­ã‚¤

`image-tag`ã¨ã„ã†åå‰ã§ãƒ‡ãƒ—ãƒ­ã‚¤ã—ã¦ãŠã

# 8. AIç·¨

- ChatGPTã¯OpenAPIã«å¯¾å¿œã™ã‚‹ => Zod OpenAPI
- ChatGPTã®Streamingã‚’æ‰±ã† => `c.streamText()`

## 8.1 ChatGPTã®Pluginã‚’ã¤ãã£ã¦ã¿ã‚ˆã†

### å®Œæˆå½¢

![output](https://github.com/yusukebe/cloudflare-workshop-examples/assets/10682/27f7167e-77f9-4319-886c-359a651f27ff)

### å®Œæˆå“ã®ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰

```txt
npx degit yusukebe/cloudflare-workshop-examples/projects/ssr ssr
```

### ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹é€ 

```txt
$ tree .
.
â”œâ”€â”€ package.json
â”œâ”€â”€ src
â”‚Â Â  â”œâ”€â”€ ai-plugin.ts
â”‚Â Â  â”œâ”€â”€ index.ts
â”‚Â Â  â””â”€â”€ routes.ts
â””â”€â”€ tsconfig.json
```

### ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ

- [Examples - OpenAI API](https://platform.openai.com/docs/plugins/examples)

### APIã®å®šç¾©ã‚’æ›¸ã

è‡ªç„¶è¨€èªã§æ›¸ã‘ã°ã‚ˆã„

```ts
// src/ai-plugin.ts
// GET /.well-known/ai-plugin.json ã«ãƒãƒƒãƒ”ãƒ³ã‚°ã•ã‚Œã‚‹
export const aiPluginJson = {
  schema_version: 'v1',
  name_for_human: 'TODO List (No Auth)',
  name_for_model: 'todo',
  description_for_human: 'Manage your TODO list. You can add, remove and view your TODOs.',
  description_for_model:
    'Plugin for managing a TODO list, you can add, remove and view your TODOs.',
  auth: {
    type: 'none',
  },
  api: {
    type: 'openapi',
    url: 'http://localhost:8787/openapi.json',
  },
  logo_url:
    'https://ss.yusukebe.com/a4ebf3360db8e05185b83866352539ff4a587f2df97273258551dbb34c88b792_800x744.png',
  contact_email: 'support@example.com',
  legal_info_url: 'https://example.com/legal',
}
```

### Zod OpenAPI

ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«

```txt
@hono/zod-openapi
```

Routeã®å®šç¾©ã€‚Zodã‚’ä½¿ã†

```ts
import { z, createRoute } from '@hono/zod-openapi'

const UsernameParamsSchema = z.object({
  username: z.string().openapi({
    description: 'The name of user.',
  }),
})

const routeGetTodos = createRoute({
  method: 'get',
  path: '/todos/{username}',
  operationId: 'getTodos',
  summary: 'Get the list of todos',
  request: {
    params: UsernameParamsSchema,
  },
  responses: {
    '200': {
      description: 'OK',
      content: {
        'application/json': {
          schema: z.object({
            todos: z.array(z.string()).openapi({
              description: 'The list of todos.',
            }),
          }),
        },
      },
    },
  },
})
```

ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã®å®Ÿè£…

```ts
app.openapi(routeGetTodos, (c) => {
  const { username } = c.req.valid('param')
  return c.jsonT({
    todos: _TODOS[username],
  })
})
```

## 8.2 ChatGPTã®Gatewayã‚’ã¤ãã£ã¦ã¿ã‚ˆã†

### å®Œæˆå½¢

![output](https://github.com/yusukebe/cloudflare-workshop-examples/assets/10682/00c8018f-f341-45e6-bfb8-7f6b2cc60959)

### å®Œæˆå“ã®ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰

```txt
npx degit yusukebe/cloudflare-workshop-examples/projects/chatgpt-streaming chatgpt-streaming
```

### Sonik

å®Ÿã¯é–‹ç™ºä¸­ã®[Sonik](https://github.com/yusukebe/sonik)ã¨ã„ã†ãƒ¡ã‚¿ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ã‚’ä½¿ã£ã¦ã„ã‚‹ã€‚

- Honoã€Viteã€UIãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’çµ„ã¿åˆã‚ã›ãŸãƒ¡ã‚¿ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯
- ãƒ•ã‚¡ã‚¤ãƒ«ãƒ™ãƒ¼ã‚¹ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°
- SSR
- ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§JavaScriptã‚ªãƒ•
- Islandãƒã‚¤ãƒ‰ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³
- UIãƒ—ãƒªã‚»ãƒƒãƒˆ
- APIã‚¢ãƒ—ãƒªã‚’ä½œã‚‹ã®ã«ã‚‚ãŠã™ã™ã‚
- Honoã®ãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢ãŒä½¿ãˆã‚‹
- ã‚¨ãƒƒã‚¸ã§å®Ÿè¡Œã•ã‚Œã‚‹ã“ã¨ã‚’æƒ³å®š

### ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹é€ 

```txt
$ tree .
.
â”œâ”€â”€ app
â”‚Â Â  â”œâ”€â”€ client.ts
â”‚Â Â  â”œâ”€â”€ islands
â”‚Â Â  â”‚Â Â  â””â”€â”€ component.tsx
â”‚Â Â  â”œâ”€â”€ routes
â”‚Â Â  â”‚Â Â  â”œâ”€â”€ _404.tsx
â”‚Â Â  â”‚Â Â  â”œâ”€â”€ _layout.tsx
â”‚Â Â  â”‚Â Â  â””â”€â”€ index.tsx
â”‚Â Â  â”œâ”€â”€ server.ts
â”‚Â Â  â””â”€â”€ style.css
â”œâ”€â”€ package.json
â”œâ”€â”€ tsconfig.json
â””â”€â”€ vite.config.ts
```

### ã‚­ãƒ¢ã¯ã“ã“

```ts
// app/routes/index.tsx
app.post('/api', async (c) => {
  const body = await c.req.json<{ message: string }>()

  const openai = new OpenAI({ apiKey: c.env.OPENAI_API_KEY })
  const chatStream = await openai.chat.completions.create({
    messages: PROMPT(body.message),
    model: 'gpt-3.5-turbo',
    stream: true,
  })

  return c.streamText(async (stream) => {
    for await (const message of chatStream) {
      await stream.write(message.choices[0]?.delta.content ?? '')
    }
  })
})
```

## 8.3 å…ˆç¨‹ã®R2ã¨çµ„ã¿åˆã‚ã›ãŸChatGPTã®Pluginã‚’ã¤ãã£ã¦ã¿ã‚ˆã†

### å®Œæˆå“ã®ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰

```txt
npx degit yusukebe/image-tag image-tag-plugin
```

### ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹æˆ


```ts
tree .
.
â”œâ”€â”€ .gitignore
â”œâ”€â”€ README.md
â”œâ”€â”€ package.json
â”œâ”€â”€ src
â”‚Â Â  â”œâ”€â”€ ai-plugin.ts
â”‚Â Â  â”œâ”€â”€ index.ts
â”‚Â Â  â””â”€â”€ routes.ts
â”œâ”€â”€ tsconfig.json
â””â”€â”€ wrangler.toml
```

### `src/ai-plugin.ts`

```ts
export const aiPluginJson = (baseURL: string) => {
  return {
    schema_version: 'v1',
    name_for_human: 'meshitero',
    name_for_model: 'meshitero',
    description_for_human: 'Meshitero Plugin',
    description_for_model:
      'This plugin is a food-terrorism plugin that shows hungry users the pictures specified in the tag.',
    auth: {
      type: 'none'
    },
    api: {
      type: 'openapi',
      url: `${baseURL}/openapi.json`
    },
    logo_url: 'https://ss.yusukebe.com/4203deb97493d70346bfff59b02d0f769467c29df64c072bc947d4a55a495dec_800x636.png',
    contact_email: 'support@example.com',
    legal_info_url: 'https://example.com/legal'
  }
}
```

### `routes.ts`

```ts
import { z, createRoute } from '@hono/zod-openapi'

export const schema = z.object({
  id: z.string(),
  tag: z.string(),
  created_at: z.string(),
  url: z.string()
})

const paramSchema = z.object({
  tag: z.enum(['è‚‰', 'ãƒ©ãƒ¼ãƒ¡ãƒ³'])
})

const routeRandom = createRoute({
  method: 'get',
  path: '/random',
  request: {
    query: paramSchema
  },
  operationId: 'random',
  summary: 'Get a random niku info',
  responses: {
    '200': {
      description: 'OK',
      content: {
        'application/json': {
          schema: schema
        }
      }
    }
  }
})

export { routeRandom }
```

### `index.ts`

```ts
import { OpenAPIHono, z } from '@hono/zod-openapi'
import { cors } from 'hono/cors'
import { aiPluginJson } from './ai-plugin'
import { routeRandom, schema } from './routes'

const app = new OpenAPIHono()
app.use('*', cors())

const apiBaseURL = 'https://image-tag.yusukebe.workers.dev'
const baseURL = 'http://localhost:8787'

app.openapi(routeRandom, async (c) => {
  const url = new URL(`${apiBaseURL}/api/random`)
  const { tag } = c.req.valid('query')
  url.searchParams.set('tag', tag)
  console.log(`Request to ${url.toString()}`)
  const resRandom = await fetch(url.toString())
  const images = await resRandom.json<z.infer<typeof schema>[]>()
  const data = images[0]
  data.url = `https://image-tag.yusukebe.workers.dev/file/${data.id}`
  return c.jsonT(data)
})

app.get('/.well-known/ai-plugin.json', (c) => {
  return c.json(aiPluginJson(baseURL))
})

app.doc('/openapi.json', {
  openapi: '3.0.1',
  info: {
    title: 'Meshitero',
    description: 'This plugin is a food-terrorism plugin that shows hungry users the pictures specified in the tag.',
    version: 'v1'
  },
  servers: [
    {
      url: baseURL
    }
  ]
})

export default app
```

## æ¶ˆã™

ã¤ãã£ãŸã‚‚ã®ã‚’æ¶ˆã—ã¦ãŠã

# 9. Honoã‚’ã‚ˆã‚Šæ·±ãä½¿ã†

## 9.1 ä»–ã®ãƒ©ãƒ³ã‚¿ã‚¤ãƒ ã§å‹•ã‹ã—ã¦ã¿ã‚ˆã†

1. aws-lambda
2. bun
3. cloudflare-pages
4. cloudflare-workers
5. deno
6. fastly
7. lagon
8. lambda-edge
9. netlify
10. nextjs
11. nodejs
12. vercel

## 9.2 å¤§ããªã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®æ§‹æˆ

- `app.route()`ã§ç¹‹ã„ã§ã„ã

## 9.3 ã‚¢ãƒ€ãƒ—ãƒˆã¨ãƒã‚¦ãƒ³ãƒˆ

### `app.mount()`

- ã‚¢ãƒ€ãƒ—ã‚¿ãƒ¼ã®ä»–ã«ãƒã‚¦ãƒ³ãƒˆã¨ã„ã†æ¦‚å¿µ
- `fetch` APIãªã‚‰ã©ã‚“ãªã‚¢ãƒ—ãƒªã‚‚ãƒã‚¦ãƒ³ãƒˆã§ãã‚‹

```ts
// Create itty-router application
const ittyRouter = IttyRouter()

// Handle `GET /itty-router/hello`
ittyRouter.get('/hello', () => new Response('Hello from itty-router!'))

// Hono application
const app = new Hono()

// Hono application
app.mount('/itty-router', ittyRouter.handle)
```

Honoã¯ãƒ©ãƒ³ã‚¿ã‚¤ãƒ ã«ã‚¢ãƒ€ãƒ—ãƒˆã—ã€ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ã‚’ãƒã‚¦ãƒ³ãƒˆã™ã‚‹

![SS](https://github-production-user-asset-6210df.s3.amazonaws.com/10682/239415401-74247b3e-0e36-4bc2-9ccd-e98f99b49466.jpg)

ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯Aã¯å„ãƒ©ãƒ³ã‚¿ã‚¤ãƒ ã¸ã®ã‚¢ãƒ€ãƒ—ã‚¿ãƒ¼ã‚’ä½œã‚ŠãŒã¡

![SS](https://github-production-user-asset-6210df.s3.amazonaws.com/10682/239415510-d077dffb-da79-442f-803e-4c155f637b93.jpg)

ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯Aã‚’å„ç¨®ãƒ©ãƒ³ã‚¿ã‚¤ãƒ ã«å¯¾å¿œã•ã›ãŸã‘ã‚Œã°ã€Honoä¸Šã§å‹•ã‘ã°ã‚ˆã„

![SS](https://github-production-user-asset-6210df.s3.amazonaws.com/10682/239415546-38ed968f-69a4-4b41-baaa-5dac5cd69679.jpg)

ãƒã‚¦ãƒ³ãƒˆã™ã‚‹ã“ã¨ã§Honoã®ãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢ãŒä½¿ãˆã‚‹

```ts
app.use('/another-app/admin/*', basicAuth({ username, password }))
```

# 10. ãã®ä»–

- Bindingsã®ãƒ†ã‚¹ãƒˆã«ã¤ã„ã¦
- Vite plugins
- Sonikã«ã¤ã„ã¦

# ãŠã¾ã‘. ã“ã®è³‡æ–™ã‚‚Workersã§ã§ãã¦ã‚‹

ã“ã‚Œã ã‘ã§ã€Markdownã‚’HTMLã«ã™ã‚‹ã‚„ã¤ã‚’ä½œã‚Œã¦ã€ãƒ‡ãƒ—ãƒ­ã‚¤ã€é…ä¿¡ã¾ã§ã§ãã¦ã—ã¾ã†

```ts
import { Hono } from 'hono'
import { marked } from 'marked'
import { rendererMiddleware } from './renderer'
import index from '../pages/index.md'

const app = new Hono()
app.get('*', rendererMiddleware)

app.get('/', (c) =>
  c.render(marked(index), {
    title: 'Cloudflare Workers + Hono Workshop'
  })
)
```

ç¨®æ˜ã‹ã—

- Markdownã‚’ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã¨ã—ã¦èª­ã¿è¾¼ã‚€
- [Marked](https://marked.js.org/)ã§HTMLã«ã™ã‚‹
- ã‚ªãƒªã‚¸ãƒŠãƒ«ã®`renderer`ã‚’å®šç¾©ã—ã¦ãŠã
- HTMLã‚’å—ã‘å–ã‚Šãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆã«åŸ‹ã‚è¾¼ã¿
- ã‚¿ã‚¤ãƒˆãƒ«ã€URLã€ã‚¤ãƒ¡ãƒ¼ã‚¸ãªã©ã‚’å—ã‘å–ã‚Šãƒ¡ã‚¿ã‚¿ã‚°ã€OGPã«ã‚»ãƒƒãƒˆ
- `favicon.ico`ã‚‚é…ä¿¡
- Workersã§ãƒ‡ãƒ—ãƒ­ã‚¤
- å…¨éƒ¨ãƒãƒ³ãƒ‰ãƒ«ã•ã‚Œã¡ã‚ƒã†ã®ã§ã€Markdownã®ãƒ†ã‚­ã‚¹ãƒˆãŒå¤šããªã‚‹ã¨ã‚µã‚¤ã‚ºãŒå¤§ãããªã‚‹

# ãƒªãƒ³ã‚¯é›†

- [Hono - Ultrafast web framework for the Edges](https://hono.dev/)
- [honojs/hono: Lightweight, Ultrafast, Web Standards](https://github.com/honojs/hono)
- [yusukebe/cloudflare-workshop-examples: Cloudflare Workers + Hono Workshop](https://github.com/yusukebe/cloudflare-workshop-examples)
- [yusukebe/cloudflare-workshop](https://github.com/yusukebe/cloudflare-workshop)
- [yusukebe/ramen-plugin](https://github.com/yusukebe/ramen-plugin)
- [yusukebe/image-tag](https://github.com/yusukebe/image-tag)
- [Cloudflare Workersãƒ—ãƒ­ã‚­ã‚·ãƒ‘ã‚¿ãƒ¼ãƒ³](https://zenn.dev/yusukebe/articles/647aa9ba8c1550)
